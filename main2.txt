from flask import Flask, request
import requests
import datetime
import json

app = Flask(__name__)

# === CONFIG ===
BOT_TOKEN = "7743481184:AAG7mt4MYz4XBGb1-SeHd0nLMy2TM6OVxys"
CHAT_ID = "-1003065878488"
CLICKUP_API_TOKEN = "pk_294795597_EONVXPYTADMLTDWZPKQJZZL59R88Q8BI"

TELEGRAM_API = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"

# === HÃ€M Gá»¬I TELEGRAM ===
def send_message(text):
    payload = {
        "chat_id": CHAT_ID,
        "text": text,
        "parse_mode": "HTML"
    }
    res = requests.post(TELEGRAM_API, json=payload)
    return res.status_code

# === HÃ€M Láº¤Y THÃ”NG TIN Tá»ª CLICKUP API ===
def get_task_info(task_id):
    """Láº¥y thÃ´ng tin chi tiáº¿t task tá»« ClickUp API"""
    url = f"https://api.clickup.com/api/v2/task/{task_id}"
    headers = {"Authorization": CLICKUP_API_TOKEN}
    
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            return response.json()
        return None
    except:
        return None

def get_space_info(space_id):
    """Láº¥y thÃ´ng tin Space/Project"""
    url = f"https://api.clickup.com/api/v2/space/{space_id}"
    headers = {"Authorization": CLICKUP_API_TOKEN}
    
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            return response.json()
        return None
    except:
        return None

def get_list_info(list_id):
    """Láº¥y thÃ´ng tin List"""
    url = f"https://api.clickup.com/api/v2/list/{list_id}"
    headers = {"Authorization": CLICKUP_API_TOKEN}
    
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            return response.json()
        return None
    except:
        return None

def get_folder_info(folder_id):
    """Láº¥y thÃ´ng tin Folder"""
    url = f"https://api.clickup.com/api/v2/folder/{folder_id}"
    headers = {"Authorization": CLICKUP_API_TOKEN}
    
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            return response.json()
        return None
    except:
        return None

# === HÃ€M FORMAT THá»œI GIAN ===
def format_timestamp(timestamp):
    """Chuyá»ƒn timestamp (ms) sang datetime tiáº¿ng Viá»‡t"""
    if not timestamp:
        return "KhÃ´ng cÃ³"
    try:
        dt = datetime.datetime.fromtimestamp(int(timestamp) / 1000)
        return dt.strftime("%H:%M %d/%m/%Y")
    except:
        return "KhÃ´ng xÃ¡c Ä‘á»‹nh"

def check_overdue(due_date):
    """Kiá»ƒm tra task cÃ³ quÃ¡ háº¡n khÃ´ng"""
    if not due_date:
        return False
    try:
        due = datetime.datetime.fromtimestamp(int(due_date) / 1000)
        now = datetime.datetime.now()
        return now > due
    except:
        return False

# === ROUTE NHáº¬N WEBHOOK Tá»ª CLICKUP ===
@app.route('/clickup', methods=['POST'])
def clickup_webhook():
    print("\n========== CLICKUP WEBHOOK ==========")
    data = request.get_json()
    
    # Log data Ä‘á»ƒ debug
    with open('clickup_data.json', 'a', encoding='utf-8') as f:
        f.write(json.dumps(data, indent=2, ensure_ascii=False))
        f.write("\n\n" + "="*50 + "\n\n")
    
    print("Body:", json.dumps(data, indent=2, ensure_ascii=False))
    print("=====================================\n")
    
    event = data.get("event", "")
    history_items = data.get("history_items", [])
    
    # Thá»i gian hiá»‡n táº¡i
    now = datetime.datetime.now().strftime("%H:%M:%S %d/%m/%Y")
    
    # Láº¥y thÃ´ng tin ngÆ°á»i thá»±c hiá»‡n action
    action_user = "KhÃ´ng rÃµ"
    if history_items:
        first_item = history_items[0]
        user_info = first_item.get("user", {})
        if isinstance(user_info, dict):
            action_user = user_info.get("username", "KhÃ´ng rÃµ")
    
    # === Xá»¬ LÃ SPACE/PROJECT EVENTS ===
    if "space" in event.lower():
        space_id = data.get("space_id", "")
        space_data = get_space_info(space_id) if space_id else None
        
        space_name = "KhÃ´ng rÃµ"
        if space_data:
            space_name = space_data.get("name", "KhÃ´ng rÃµ")
        
        if event == "spaceCreated":
            msg = f"""
ğŸ¢ <b>PROJECT Má»šI ÄÆ¯á»¢C Táº O</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ <b>{space_name}</b>
ğŸ‘¤ NgÆ°á»i táº¡o: <b>{action_user}</b>
ğŸ•’ Táº¡o lÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            send_message(msg.strip())
        
        elif event == "spaceUpdated":
            msg = f"""
ğŸ”„ <b>Cáº¬P NHáº¬T PROJECT</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ <b>{space_name}</b>
ğŸ‘¤ NgÆ°á»i cáº­p nháº­t: <b>{action_user}</b>
ğŸ•’ LÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            send_message(msg.strip())
        
        elif event == "spaceDeleted":
            msg = f"""
ğŸ—‘ï¸ <b>XÃ“A PROJECT</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ <b>{space_name}</b>
ğŸ‘¤ NgÆ°á»i xÃ³a: <b>{action_user}</b>
ğŸ•’ XÃ³a lÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            send_message(msg.strip())
    
    # === Xá»¬ LÃ FOLDER EVENTS ===
    elif "folder" in event.lower():
        folder_id = data.get("folder_id", "")
        folder_data = get_folder_info(folder_id) if folder_id else None
        
        folder_name = "KhÃ´ng rÃµ"
        if folder_data:
            folder_name = folder_data.get("name", "KhÃ´ng rÃµ")
        
        if event == "folderCreated":
            msg = f"""
ğŸ“‚ <b>FOLDER Má»šI ÄÆ¯á»¢C Táº O</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ <b>{folder_name}</b>
ğŸ‘¤ NgÆ°á»i táº¡o: <b>{action_user}</b>
ğŸ•’ Táº¡o lÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            send_message(msg.strip())
        
        elif event == "folderUpdated":
            msg = f"""
ğŸ”„ <b>Cáº¬P NHáº¬T FOLDER</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ <b>{folder_name}</b>
ğŸ‘¤ NgÆ°á»i cáº­p nháº­t: <b>{action_user}</b>
ğŸ•’ LÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            send_message(msg.strip())
        
        elif event == "folderDeleted":
            msg = f"""
ğŸ—‘ï¸ <b>XÃ“A FOLDER</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ <b>{folder_name}</b>
ğŸ‘¤ NgÆ°á»i xÃ³a: <b>{action_user}</b>
ğŸ•’ XÃ³a lÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            send_message(msg.strip())
    
    # === Xá»¬ LÃ LIST EVENTS ===
    elif "list" in event.lower():
        list_id = data.get("list_id", "")
        list_data = get_list_info(list_id) if list_id else None
        
        list_name = "KhÃ´ng rÃµ"
        if list_data:
            list_name = list_data.get("name", "KhÃ´ng rÃµ")
        
        if event == "listCreated":
            msg = f"""
ğŸ“ <b>LIST Má»šI ÄÆ¯á»¢C Táº O</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{list_name}</b>
ğŸ‘¤ NgÆ°á»i táº¡o: <b>{action_user}</b>
ğŸ•’ Táº¡o lÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            send_message(msg.strip())
        
        elif event == "listUpdated":
            msg = f"""
ğŸ”„ <b>Cáº¬P NHáº¬T LIST</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{list_name}</b>
ğŸ‘¤ NgÆ°á»i cáº­p nháº­t: <b>{action_user}</b>
ğŸ•’ LÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            send_message(msg.strip())
        
        elif event == "listDeleted":
            msg = f"""
ğŸ—‘ï¸ <b>XÃ“A LIST</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{list_name}</b>
ğŸ‘¤ NgÆ°á»i xÃ³a: <b>{action_user}</b>
ğŸ•’ XÃ³a lÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            send_message(msg.strip())
    
    # === Xá»¬ LÃ TASK EVENTS ===
    elif "task" in event.lower():
        task_id = data.get("task_id", "")
        
        # Láº¥y thÃ´ng tin task tá»« API
        task_data = get_task_info(task_id)
        
        if not task_data:
            print("KhÃ´ng láº¥y Ä‘Æ°á»£c thÃ´ng tin task tá»« API")
            return {"ok": True}, 200
        
        # Parse thÃ´ng tin task
        task_name = task_data.get("name", "KhÃ´ng rÃµ")
        task_url = task_data.get("url", "")
        
        # Status
        status_info = task_data.get("status", {})
        status = status_info.get("status", "KhÃ´ng rÃµ") if isinstance(status_info, dict) else "KhÃ´ng rÃµ"
        
        # Creator (ngÆ°á»i táº¡o task)
        creator = task_data.get("creator", {})
        creator_name = creator.get("username", "KhÃ´ng rÃµ") if isinstance(creator, dict) else "KhÃ´ng rÃµ"
        
        # Assignees (ngÆ°á»i Ä‘Æ°á»£c phÃ¢n cÃ´ng)
        assignees = task_data.get("assignees", [])
        if assignees:
            assignees_list = [a.get("username", "N/A") for a in assignees]
            assignees_text = ", ".join(assignees_list)
        else:
            assignees_text = "ChÆ°a phÃ¢n cÃ´ng"
        
        # Priority
        priority = task_data.get("priority")
        priority_text = "KhÃ´ng cÃ³"
        if priority:
            priority_map = {
                1: "ğŸ”´ Kháº©n cáº¥p",
                2: "ğŸŸ  Cao",
                3: "ğŸŸ¡ BÃ¬nh thÆ°á»ng",
                4: "ğŸ”µ Tháº¥p"
            }
            if isinstance(priority, dict):
                priority_text = priority_map.get(priority.get("priority"), "KhÃ´ng cÃ³")
        
        # Due date
        due_date = task_data.get("due_date")
        due_date_text = "KhÃ´ng cÃ³"
        is_overdue = False
        if due_date:
            due_date_text = format_timestamp(due_date)
            is_overdue = check_overdue(due_date)
        
        # Date created
        date_created = task_data.get("date_created")
        created_time = format_timestamp(date_created)
        
        # 1. TASK Má»šI ÄÆ¯á»¢C Táº O
        if event == "taskCreated":
            overdue_warning = ""
            if is_overdue:
                overdue_warning = "\nâš ï¸ <b>Cáº¢NH BÃO: ÄÃƒ QUÃ Háº N!</b>"
            
            msg = f"""
ğŸ†• <b>TASK Má»šI ÄÆ¯á»¢C Táº O</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{task_name}</b>
ğŸ‘¤ NgÆ°á»i táº¡o: <b>{creator_name}</b>
ğŸ‘¥ PhÃ¢n cÃ´ng: <b>{assignees_text}</b>
âš¡ Má»©c Ä‘á»™: {priority_text}
ğŸ“… Deadline: {due_date_text}{overdue_warning}
ğŸ•’ Táº¡o lÃºc: {created_time}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— <a href="{task_url}">Xem chi tiáº¿t</a>
"""
            send_message(msg.strip())
        
        # 2. TASK Cáº¬P NHáº¬T
        elif event == "taskUpdated":
            # Check cÃ¡c loáº¡i cáº­p nháº­t
            for item in history_items:
                field = item.get("field", "")
                
                # A. Status thay Ä‘á»•i
                if field == "status":
                    before = item.get("before", {})
                    after = item.get("after", {})
                    
                    old_status = before.get("status", "KhÃ´ng rÃµ") if isinstance(before, dict) else "KhÃ´ng rÃµ"
                    new_status = after.get("status", "KhÃ´ng rÃµ") if isinstance(after, dict) else "KhÃ´ng rÃµ"
                    
                    # Check náº¿u chuyá»ƒn sang completed/closed
                    if new_status.lower() in ["complete", "completed", "closed", "done"]:
                        # TÃ­nh toÃ¡n thá»i gian hoÃ n thÃ nh so vá»›i deadline
                        completion_status = ""
                        time_diff_msg = ""
                        
                        if due_date:
                            try:
                                due_datetime = datetime.datetime.fromtimestamp(int(due_date) / 1000)
                                now_datetime = datetime.datetime.now()
                                time_diff = due_datetime - now_datetime
                                
                                # TÃ­nh sá»‘ giá» chÃªnh lá»‡ch
                                hours_diff = time_diff.total_seconds() / 3600
                                days_diff = time_diff.days
                                
                                if hours_diff < 0:
                                    # HoÃ n thÃ nh SAU deadline (trá»…)
                                    abs_hours = abs(hours_diff)
                                    if abs_hours < 24:
                                        time_diff_msg = f"\nâ° Trá»… deadline: <b>{int(abs_hours)} giá» {int((abs_hours % 1) * 60)} phÃºt</b>"
                                    else:
                                        time_diff_msg = f"\nâ° Trá»… deadline: <b>{abs(days_diff)} ngÃ y</b>"
                                    completion_status = "\nğŸ”´ <b>TRáº NG THÃI: TRá»„ DEADLINE</b>"
                                elif hours_diff >= 24:
                                    # HoÃ n thÃ nh sá»›m hÆ¡n 24h (vÆ°á»£t tiáº¿n Ä‘á»™)
                                    if days_diff >= 1:
                                        time_diff_msg = f"\nâš¡ HoÃ n thÃ nh sá»›m: <b>{days_diff} ngÃ y</b>"
                                    else:
                                        time_diff_msg = f"\nâš¡ HoÃ n thÃ nh sá»›m: <b>{int(hours_diff)} giá»</b>"
                                    completion_status = "\nğŸŒŸ <b>VÆ¯á»¢T TIáº¾N Äá»˜! XUáº¤T Sáº®C!</b> ğŸ‰"
                                else:
                                    # HoÃ n thÃ nh trong vÃ²ng 24h trÆ°á»›c deadline (Ä‘Ãºng tiáº¿n Ä‘á»™)
                                    time_diff_msg = f"\nâ° CÃ²n {int(hours_diff)} giá» {int((hours_diff % 1) * 60)} phÃºt Ä‘áº¿n deadline"
                                    completion_status = "\nâœ… <b>HOÃ€N THÃ€NH ÄÃšNG TIáº¾N Äá»˜!</b> ğŸ‘"
                            except:
                                pass
                        else:
                            completion_status = "\nâœ… <b>HOÃ€N THÃ€NH!</b>"
                        
                        # Thá»i gian táº¡o task
                        time_to_complete = ""
                        if date_created:
                            try:
                                created_dt = datetime.datetime.fromtimestamp(int(date_created) / 1000)
                                now_dt = datetime.datetime.now()
                                duration = now_dt - created_dt
                                
                                if duration.days > 0:
                                    time_to_complete = f"\nâ±ï¸ Thá»i gian lÃ m: <b>{duration.days} ngÃ y {duration.seconds // 3600} giá»</b>"
                                else:
                                    hours = duration.seconds // 3600
                                    minutes = (duration.seconds % 3600) // 60
                                    time_to_complete = f"\nâ±ï¸ Thá»i gian lÃ m: <b>{hours} giá» {minutes} phÃºt</b>"
                            except:
                                pass
                        
                        msg = f"""
âœ… <b>TASK HOÃ€N THÃ€NH</b>{completion_status}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{task_name}</b>
ğŸ‘¤ NgÆ°á»i hoÃ n thÃ nh: <b>{action_user}</b>
ğŸ‘¥ ÄÃ£ phÃ¢n cÃ´ng cho: <b>{assignees_text}</b>
âš¡ Má»©c Ä‘á»™: {priority_text}
ğŸ“… Deadline: {due_date_text}{time_diff_msg}{time_to_complete}
ğŸ•’ HoÃ n thÃ nh lÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— <a href="{task_url}">Xem chi tiáº¿t</a>
"""
                        send_message(msg.strip())
                    
                    # ThÃ´ng bÃ¡o chuyá»ƒn status khÃ¡c
                    else:
                        msg = f"""
ğŸ”„ <b>THAY Äá»”I TRáº NG THÃI</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{task_name}</b>
ğŸ‘¤ NgÆ°á»i thay Ä‘á»•i: <b>{action_user}</b>
ğŸ“Œ Tá»«: {old_status} â†’ <b>{new_status}</b>
ğŸ•’ LÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— <a href="{task_url}">Xem chi tiáº¿t</a>
"""
                        send_message(msg.strip())
                
                # B. Assignee thÃªm má»›i
                elif field == "assignee_add":
                    after = item.get("after", {})
                    new_assignee = after.get("username", "KhÃ´ng rÃµ") if isinstance(after, dict) else "KhÃ´ng rÃµ"
                    
                    overdue_warning = ""
                    if is_overdue:
                        overdue_warning = "\nâš ï¸ <b>Task Ä‘Ã£ quÃ¡ háº¡n!</b>"
                    
                    msg = f"""
ğŸ‘¤ <b>PHÃ‚N CÃ”NG TASK</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{task_name}</b>
â• ÄÆ°á»£c giao cho: <b>{new_assignee}</b>
ğŸ“… Deadline: {due_date_text}{overdue_warning}
ğŸ•’ LÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— <a href="{task_url}">Xem chi tiáº¿t</a>
"""
                    send_message(msg.strip())
                
                # C. Assignee bá»‹ xÃ³a
                elif field == "assignee_rem":
                    before = item.get("before", {})
                    removed_assignee = before.get("username", "KhÃ´ng rÃµ") if isinstance(before, dict) else "KhÃ´ng rÃµ"
                    
                    msg = f"""
ğŸ‘¤ <b>XÃ“A PHÃ‚N CÃ”NG</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{task_name}</b>
â– ÄÃ£ xÃ³a: <b>{removed_assignee}</b>
ğŸ•’ LÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— <a href="{task_url}">Xem chi tiáº¿t</a>
"""
                    send_message(msg.strip())
                
                # D. Due date thay Ä‘á»•i
                elif field == "due_date":
                    after = item.get("after", {})
                    new_due = format_timestamp(after) if after else "KhÃ´ng cÃ³"
                    
                    msg = f"""
ğŸ“… <b>THAY Äá»”I DEADLINE</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{task_name}</b>
ğŸ‘¤ NgÆ°á»i thay Ä‘á»•i: <b>{action_user}</b>
ğŸ“… Deadline má»›i: <b>{new_due}</b>
ğŸ‘¥ Phá»¥ trÃ¡ch: {assignees_text}
ğŸ•’ LÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— <a href="{task_url}">Xem chi tiáº¿t</a>
"""
                    send_message(msg.strip())
                
                # E. TÃªn task thay Ä‘á»•i
                elif field == "name":
                    before_name = item.get("before", "KhÃ´ng rÃµ")
                    after_name = item.get("after", "KhÃ´ng rÃµ")
                    
                    msg = f"""
âœï¸ <b>Äá»”I TÃŠN TASK</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ Tá»«: <b>{before_name}</b>
â¡ï¸ ThÃ nh: <b>{after_name}</b>
ğŸ‘¤ NgÆ°á»i Ä‘á»•i: <b>{action_user}</b>
ğŸ•’ LÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— <a href="{task_url}">Xem chi tiáº¿t</a>
"""
                    send_message(msg.strip())
            
            # Check task quÃ¡ háº¡n (chá»‰ khi task chÆ°a hoÃ n thÃ nh)
            if is_overdue and status.lower() not in ["complete", "completed", "closed", "done"]:
                msg = f"""
âš ï¸ <b>Cáº¢NH BÃO: TASK QUÃ Háº N!</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{task_name}</b>
ğŸ‘¥ NgÆ°á»i phá»¥ trÃ¡ch: <b>{assignees_text}</b>
ğŸ“… Deadline: {due_date_text}
â° <b>ÄÃƒ QUÃ Háº N!</b>
ğŸ“Œ Tráº¡ng thÃ¡i: {status}
ğŸ•’ Kiá»ƒm tra lÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— <a href="{task_url}">Xem ngay</a>
"""
                send_message(msg.strip())
        
        # 3. TASK Bá»Š XÃ“A
        elif event == "taskDeleted":
            msg = f"""
ğŸ—‘ï¸ <b>TASK ÄÃƒ Bá»Š XÃ“A</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>{task_name}</b>
ğŸ‘¤ NgÆ°á»i xÃ³a: <b>{action_user}</b>
ğŸ‘¥ ÄÃ£ phÃ¢n cÃ´ng cho: {assignees_text}
ğŸ•’ XÃ³a lÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
            send_message(msg.strip())
        
        # 4. COMMENT Má»šI
        elif event == "taskCommentPosted":
            comment_text = "KhÃ´ng cÃ³ ná»™i dung"
            for item in history_items:
                if item.get("field") == "comment":
                    comment_data = item.get("comment", {})
                    if isinstance(comment_data, dict):
                        comment_text = comment_data.get("text_content", "KhÃ´ng cÃ³ ná»™i dung")
                    break
            
            # Cáº¯t comment náº¿u quÃ¡ dÃ i
            if len(comment_text) > 200:
                comment_text = comment_text[:200] + "..."
            
            msg = f"""
ğŸ’¬ <b>COMMENT Má»šI</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ Task: <b>{task_name}</b>
ğŸ‘¤ NgÆ°á»i comment: <b>{action_user}</b>
ğŸ’­ Ná»™i dung: {comment_text}
ğŸ•’ LÃºc: {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— <a href="{task_url}">Xem chi tiáº¿t</a>
"""
            send_message(msg.strip())
    
    return {"ok": True}, 200

@app.route('/', methods=['GET'])
def home():
    return "âœ… ClickUp â†” Telegram bot Ä‘ang hoáº¡t Ä‘á»™ng!", 200

@app.route('/test', methods=['GET'])
def test():
    send_message("ğŸ§ª Test message tá»« ClickUp bot!")
    return "Message sent!", 200

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=5000, debug=True)